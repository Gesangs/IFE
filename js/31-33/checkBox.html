<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>checkBox</title>
    <style>
        th, td {
            text-align: center;
            width: 70px;
        }
    </style>
</head>
<body>
    <div id="region-radio-wrapper"></div>
    <div id="product-radio-wrapper"></div>

    <div id="table-wrapper"></div>

    <script src="./ife31data.js"></script>
    <script>
        let $div = document.getElementById("table-wrapper");


        function createCheckBox($div, name, data) {
            data.map((item, index) => {
                // 生成checkBox
                let $input = document.createElement("input");
                $input.type = "checkbox";
                $input.value = item.value;
                index == 0 ? $input.checked = "true" : "";
                $input.name = item.value !== "全选" ? name : "all"; 
                $div.appendChild($input);
                // 生成选项描述
                let $text = document.createTextNode(item.value);
                $div.appendChild($text);
            })
            
            $div.addEventListener("click", (e) => {
                let $target = e.target;
                if($target.name === "all") {
                    let $checkBox = $div.querySelectorAll(`input[name=${name}]`);
                    [...$checkBox].map((item) => {
                        item.checked = "true";
                    })
                } else if($target.type === "checkbox") {
                    // 获取所有非全选选项
                    let $checkBoxAll = $div.querySelectorAll(`input[name=${name}]`);  
                    // 获取所有选中的选项  
                    let $checkBox = $div.querySelectorAll(`input[name=${name}]:checked`);
                    // 获取全选按钮
                    let $all = $div.querySelector("input[name='all']");                
                    // 如果被选中且唯一，则再次选中
                    if($checkBox.length == 0) {
                        $target.checked = "true"
                    } else if($checkBox.length === $checkBoxAll.length) {
                        // 如果满足全选状态，就选中全选按钮
                        $all.checked = true;
                    } else if($checkBox.length !== $checkBoxAll.length && $all.checked) {
                        // 如果已经不满足全选状态，就取消选中全选按钮
                        $all.checked = false;    
                    }
                }
            }, true)
        }

        createCheckBox(document.getElementById("region-radio-wrapper"), "region", [
            {value: "华南"},
            {value: "华东"},
            {value: "华北"},
            {value: "全选"}
        ])
        createCheckBox(document.getElementById("product-radio-wrapper"), "product", [
            {value: "手机"},
            {value: "笔记本"},
            {value: "智能音箱"},
            {value: "全选"}            
        ])
        
         

        function getSelectBox(name) {
            let result = [];
            let $node = document.querySelectorAll(`input[name=${name}]:checked`);
            [...$node].map((item) => {
                result.push(item.value);
            })
            return result;
        }

        function getTableData() {
            let selectData = [];
            let product = getSelectBox('product');
            let region = getSelectBox("region");
            if(region.length == 1) {
                sourceData.map((item) => {
                    if(region[0] === item.region && product.includes(item.product)) {
                        selectData.push(item)
                    }
                })
            } else if(product.length == 1) {
                sourceData.map((item) => {
                    if(product[0] === item.product && region.includes(item.region)) {
                        selectData.push(item)
                    }
                })
            } else {
                sourceData.map((item) => {
                    if(product.includes(item.product) && region.includes(item.region)) {
                        selectData.push(item)
                    }
                })
            }
            return selectData;
        }

        window.addEventListener("change", () => {
                $div.innerHTML = "";
                drawTable()
        },true)


            function createTableColumn(arr, type) {
                let $td;
                let $tr = document.createElement("tr");

                arr.map((item) => {
                    $td = document.createElement(type);
                    $td.innerHTML = item;
                    $tr.appendChild($td);
                })

                return $tr;
            }
            
            function productOrRegionFirst(arr) {
                let productLen = getSelectBox("product").length;
                let regionLen = getSelectBox("region").length;
                if(productLen == 1 && regionLen == 1) {
                    return arr;
                } else if(productLen == 1 && regionLen >1) {
                    return arr;
                } else if(productLen > 1 && regionLen > 1) {
                    return arr;
                } else if(regionLen == 1 && productLen >1) {
                    return arr.reverse();
                }
            }

            function createThArr() {
                let mouthArr = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
                return productOrRegionFirst(["商品", "地区"]).concat(mouthArr);
            }

            function createTdArr(obj) {
                let mouthArr = [];
                let result = []
                for(let item in obj) {
                    if(item === "sale") {
                        mouthArr = obj[item];
                    } else if (item === "product") {
                        result[0] = obj[item];
                    } else if(item === "region") {
                        result[1] = obj[item];
                    }
                }
                return productOrRegionFirst(result).concat(mouthArr);
            }


            function drawTable() {
                let data = getTableData();
                // 创建带有表头的空表格
                let $table = document.createElement("table");
                    $table.appendChild(createTableColumn(createThArr(), "th"));
                
                data.map((item) => {
                    $table.appendChild(createTableColumn(createTdArr(item), "td"));                    
                })
                $div.appendChild($table);                                   
            }
            drawTable()
            
    </script>
</body>
</html>